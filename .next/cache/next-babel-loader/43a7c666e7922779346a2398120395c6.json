{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport axios from 'axios';\n\n// having a changelog is mandatory\nfunction add_changelog(manifest, userQname, changelogStr) {\n  var now = new Date();\n  var changelog = {\n    time: now.toISOString(),\n    message: changelogStr,\n    user: userQname\n  };\n  manifest.changes.push(changelog);\n}\n\nfunction saveManifest(_x, _x2) {\n  return _saveManifest.apply(this, arguments);\n}\n\nfunction _saveManifest() {\n  _saveManifest = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(manifest, auth0) {\n    var changelogStr,\n        app_token,\n        volume,\n        response,\n        _args = arguments;\n    return _regeneratorRuntime.wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            changelogStr = _args.length > 2 && _args[2] !== undefined ? _args[2] : {\n              '@value': 'no log message',\n              '@language': 'en'\n            };\n\n            if (!(auth0 && auth0.isAuthenticated)) {\n              _context.next = 18;\n              break;\n            }\n\n            console.log('user', auth0.user); // DEPRECATED ? not sure we really need this...\n            // get an app token from IIIFPres Auth0 app\n            // const json = await axios.post(\"https://bdrc-io.auth0.com/oauth/token\", config.iiifpres, { headers: { 'content-type': 'application/json' } })\n            // const app_token = json.data.access_token\n\n            app_token = localStorage.getItem('id_token'); // and a changelog string must be provided (when the save button is pressed)\n            // post updated manifest to api!\n\n            volume = manifest['imggroup'];\n            add_changelog(manifest, auth0.user.bdrcID, changelogStr);\n            _context.prev = 6;\n            _context.next = 9;\n            return axios.put(\"https://iiifpres-dev.bdrc.io/bvm/ig:\".concat(volume), manifest, {\n              headers: {\n                Authorization: 'Bearer ' + app_token\n              }\n            });\n\n          case 9:\n            response = _context.sent;\n            manifest.rev = response.data.rev;\n            _context.next = 16;\n            break;\n\n          case 13:\n            _context.prev = 13;\n            _context.t0 = _context[\"catch\"](6);\n            // TODO: print error:\n            console.error(_context.t0);\n\n          case 16:\n            _context.next = 19;\n            break;\n\n          case 18:\n            console.error('users must be logged in');\n\n          case 19:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee, null, [[6, 13]]);\n  }));\n  return _saveManifest.apply(this, arguments);\n}\n\nexport default saveManifest;","map":{"version":3,"sources":["/Users/aplchian/Documents/code/buda-next/api/postUpdate.ts"],"names":["axios","add_changelog","manifest","userQname","changelogStr","now","Date","changelog","time","toISOString","message","user","changes","push","saveManifest","auth0","isAuthenticated","console","log","app_token","localStorage","getItem","volume","bdrcID","put","headers","Authorization","response","rev","data","error"],"mappings":";;AAAA,OAAOA,KAAP,MAAkB,OAAlB;;AAIA;AACA,SAASC,aAAT,CAAuBC,QAAvB,EAAgDC,SAAhD,EAAmEC,YAAnE,EAA4F;AACxF,MAAMC,GAAG,GAAG,IAAIC,IAAJ,EAAZ;AACA,MAAMC,SAAS,GAAG;AACdC,IAAAA,IAAI,EAAEH,GAAG,CAACI,WAAJ,EADQ;AAEdC,IAAAA,OAAO,EAAEN,YAFK;AAGdO,IAAAA,IAAI,EAAER;AAHQ,GAAlB;AAKAD,EAAAA,QAAQ,CAACU,OAAT,CAAiBC,IAAjB,CAAsBN,SAAtB;AACH;;SAMcO,Y;;;;;2EAAf,iBACIZ,QADJ,EAEIa,KAFJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGIX,YAAAA,YAHJ,2DAGmB;AAAE,wBAAU,gBAAZ;AAA8B,2BAAa;AAA3C,aAHnB;;AAAA,kBAMQW,KAAK,IAAIA,KAAK,CAACC,eANvB;AAAA;AAAA;AAAA;;AAOQC,YAAAA,OAAO,CAACC,GAAR,CAAY,MAAZ,EAAoBH,KAAK,CAACJ,IAA1B,EAPR,CASQ;AACA;AACA;AACA;;AAEMQ,YAAAA,SAdd,GAc0BC,YAAY,CAACC,OAAb,CAAqB,UAArB,CAd1B,EAgBQ;AAEA;;AACMC,YAAAA,MAnBd,GAmBuBpB,QAAQ,CAAC,UAAD,CAnB/B;AAoBQD,YAAAA,aAAa,CAACC,QAAD,EAAWa,KAAK,CAACJ,IAAN,CAAWY,MAAtB,EAA8BnB,YAA9B,CAAb;AApBR;AAAA;AAAA,mBAsB6DJ,KAAK,CAACwB,GAAN,+CACNF,MADM,GAE7CpB,QAF6C,EAG7C;AACIuB,cAAAA,OAAO,EAAE;AACLC,gBAAAA,aAAa,EAAE,YAAYP;AADtB;AADb,aAH6C,CAtB7D;;AAAA;AAsBkBQ,YAAAA,QAtBlB;AA+BYzB,YAAAA,QAAQ,CAAC0B,GAAT,GAAeD,QAAQ,CAACE,IAAT,CAAcD,GAA7B;AA/BZ;AAAA;;AAAA;AAAA;AAAA;AAiCY;AACAX,YAAAA,OAAO,CAACa,KAAR;;AAlCZ;AAAA;AAAA;;AAAA;AAqCQb,YAAAA,OAAO,CAACa,KAAR,CAAc,yBAAd;;AArCR;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;;;AAyCA,eAAehB,YAAf","sourcesContent":["import axios from 'axios'\nimport { AxiosResponse } from \"axios\";\nimport { Buda } from '../../buda/types'\n\n// having a changelog is mandatory\nfunction add_changelog(manifest: Buda.Manifest, userQname: string, changelogStr: Buda.Text) {\n    const now = new Date()\n    const changelog = {\n        time: now.toISOString(),\n        message: changelogStr,\n        user: userQname,\n    }\n    manifest.changes.push(changelog)\n}\n\ninterface PutAnswer {\n    rev: string\n}\n\nasync function saveManifest(\n    manifest: Buda.Manifest,\n    auth0: any,\n    changelogStr = { '@value': 'no log message', '@language': 'en' }\n) {\n    // first check: users must be logged in\n    if (auth0 && auth0.isAuthenticated) {\n        console.log('user', auth0.user)\n\n        // DEPRECATED ? not sure we really need this...\n        // get an app token from IIIFPres Auth0 app\n        // const json = await axios.post(\"https://bdrc-io.auth0.com/oauth/token\", config.iiifpres, { headers: { 'content-type': 'application/json' } })\n        // const app_token = json.data.access_token\n\n        const app_token = localStorage.getItem('id_token')\n\n        // and a changelog string must be provided (when the save button is pressed)\n\n        // post updated manifest to api!\n        const volume = manifest['imggroup']\n        add_changelog(manifest, auth0.user.bdrcID, changelogStr)\n        try {\n            const response: AxiosResponse<PutAnswer> = await axios.put(\n                `https://iiifpres-dev.bdrc.io/bvm/ig:${volume}`,\n                manifest,\n                {\n                    headers: {\n                        Authorization: 'Bearer ' + app_token,\n                    },\n                }\n            )\n            manifest.rev = response.data.rev\n        } catch (err) {\n            // TODO: print error:\n            console.error(err)\n        }\n    } else {\n        console.error('users must be logged in')\n    }\n}\n\nexport default saveManifest\n"]},"metadata":{},"sourceType":"module"}