{"ast":null,"code":"import uuidv4 from 'uuid/v4';\nimport axios from 'axios';\nimport { assoc, lensPath, map, over } from 'ramda';\nvar apiroot = 'https://iiifpres.bdrc.io';\n\nasync function getImageList(volumeQname) {\n  const data = await axios.get(`${apiroot}/il/v:${volumeQname}`);\n  return data.data.map(({\n    filename\n  }) => ({\n    filename\n  }));\n}\n\nasync function getManifest(volumeQname) {\n  // this returns an existing manifest, might return a 404\n  const {\n    data\n  } = await axios.get(`${apiroot}/bvm/ig:${volumeQname}`);\n  return data;\n}\n\nexport async function getOrInitManifest(volumeQname, options) {\n  var manifest;\n\n  try {\n    manifest = await getManifest(volumeQname);\n  } catch (err) {\n    console.log('err!', err);\n    console.log('err.response.status', err.response.status);\n\n    if (err.response.status !== 404) {\n      throw err;\n    }\n\n    const images = await getImageList(volumeQname);\n    manifest = initManifestFromImageList(images, volumeQname, options);\n  }\n\n  const addIdsToImages = manifest => {\n    const imageListLens = lensPath(['view', 'view1', 'imagelist']);\n    return over(imageListLens, map(img => assoc('id', uuidv4(), img)), manifest);\n  };\n\n  manifest.appData.bvmt['default-ui-string-lang'] = options.uiLanguage;\n  return {\n    manifest: addIdsToImages(manifest)\n  };\n}\n\nfunction initManifestFromImageList(images, volumeQname, options) {\n  return {\n    'imggroup': volumeQname,\n    'volume-label': [],\n    // an option\n    'spec-version': '0.1.0',\n    rev: null,\n    'viewing-direction': 'top-to-bottom',\n    status: 'editing',\n    note: [],\n    changes: [],\n    attribution: [],\n    // the attribution of the data in the manifest, if the user wants to be credited\n    // a reasonable default\n    pagination: [{\n      id: 'pgfolios',\n      type: 'folios'\n    }],\n    'default-view': 'view1',\n    view: {\n      view1: {\n        imagelist: images\n      }\n    },\n    appData: {\n      bvmt: {\n        'metadata-for-bvmt-ver': '0.1.0',\n        // TODO: ajust if necessary\n        'default-ui-string-lang': options.uiLanguage,\n        'default-vol-string-lang': 'bo',\n        // reasonable default for now, should be an option\n        'margin-indication-even': '{pagenum:bo}',\n        // an option\n        'margin-volname': '',\n        // an option too\n        'margin-indication-odd': '',\n        'preview-image-view': {\n          zoom: 0,\n          center: {\n            x: null,\n            y: null\n          },\n          rotation: 0\n        }\n      }\n    }\n  };\n}","map":{"version":3,"sources":["/Users/aplchian/Documents/code/buda-next/api/getManifest.ts"],"names":["uuidv4","axios","assoc","lensPath","map","over","apiroot","getImageList","volumeQname","data","get","filename","getManifest","getOrInitManifest","options","manifest","err","console","log","response","status","images","initManifestFromImageList","addIdsToImages","imageListLens","img","appData","bvmt","uiLanguage","rev","note","changes","attribution","pagination","id","type","view","view1","imagelist","zoom","center","x","y","rotation"],"mappings":"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","sourcesContent":["import uuidv4 from 'uuid/v4'\nimport axios from 'axios'\nimport { assoc, lensPath, map, over } from 'ramda'\nimport { Buda } from '../../buda/types'\n\nvar apiroot = 'https://iiifpres.bdrc.io'\n\ninterface Options {\n    uiLanguage: string\n}\n\nasync function getImageList(volumeQname: string) {\n    const data = await axios.get(`${apiroot}/il/v:${volumeQname}`)\n    return data.data.map(({ filename }: { filename: string }) => ({\n        filename,\n    }))\n}\n\nasync function getManifest(volumeQname: string) {\n    // this returns an existing manifest, might return a 404\n    const { data } = await axios.get(`${apiroot}/bvm/ig:${volumeQname}`)\n    return data\n}\n\nexport async function getOrInitManifest(volumeQname: string, options: Options) {\n    var manifest\n\n    try {\n        manifest = await getManifest(volumeQname)\n    } catch (err) {\n        console.log('err!', err)\n        console.log('err.response.status', err.response.status)\n        if (err.response.status !== 404) {\n            throw err\n        }\n        const images = await getImageList(volumeQname)\n        manifest = initManifestFromImageList(images, volumeQname, options)\n    }\n    const addIdsToImages = (manifest: Buda.Manifest) => {\n        const imageListLens = lensPath(['view', 'view1', 'imagelist'])\n        return over(\n            imageListLens,\n            map(img => assoc('id', uuidv4(), img)),\n            manifest\n        )\n    }\n    manifest.appData.bvmt['default-ui-string-lang'] = options.uiLanguage\n    return { manifest: addIdsToImages(manifest) }\n}\n\nfunction initManifestFromImageList(\n    images: Buda.Image[],\n    volumeQname: string,\n    options: Options\n): Buda.Manifest {\n    return {\n        'imggroup': volumeQname,\n        'volume-label': [], // an option\n        'spec-version': '0.1.0',\n        rev: null,\n        'viewing-direction': 'top-to-bottom',\n        status: 'editing',\n        note: [],\n        changes: [],\n        attribution: [], // the attribution of the data in the manifest, if the user wants to be credited\n        // a reasonable default\n        pagination: [\n            {\n                id: 'pgfolios',\n                type: 'folios',\n            },\n        ],\n        'default-view': 'view1',\n        view: {\n            view1: {\n                imagelist: images,\n            },\n        },\n        appData: {\n            bvmt: {\n                'metadata-for-bvmt-ver': '0.1.0', // TODO: ajust if necessary\n                'default-ui-string-lang': options.uiLanguage,\n                'default-vol-string-lang': 'bo', // reasonable default for now, should be an option\n                'margin-indication-even': '{pagenum:bo}', // an option\n                'margin-volname': '', // an option too\n                'margin-indication-odd': '',\n                'preview-image-view': {\n                    zoom: 0,\n                    center: { x: null, y: null },\n                    rotation: 0,\n                },\n            },\n        },\n    }\n}\n"]},"metadata":{},"sourceType":"module"}