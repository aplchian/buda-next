{"ast":null,"code":"import axios from 'axios';\n\n// having a changelog is mandatory\nfunction add_changelog(manifest, userQname, changelogStr) {\n  const now = new Date();\n  const changelog = {\n    time: now.toISOString(),\n    message: changelogStr,\n    user: userQname\n  };\n  manifest.changes.push(changelog);\n}\n\nasync function saveManifest(manifest, auth0, changelogStr = {\n  '@value': 'no log message',\n  '@language': 'en'\n}) {\n  // first check: users must be logged in\n  if (auth0 && auth0.isAuthenticated) {\n    console.log('user', auth0.user); // DEPRECATED ? not sure we really need this...\n    // get an app token from IIIFPres Auth0 app\n    // const json = await axios.post(\"https://bdrc-io.auth0.com/oauth/token\", config.iiifpres, { headers: { 'content-type': 'application/json' } })\n    // const app_token = json.data.access_token\n\n    const app_token = localStorage.getItem('id_token'); // and a changelog string must be provided (when the save button is pressed)\n    // post updated manifest to api!\n\n    const volume = manifest['imggroup'];\n    add_changelog(manifest, auth0.user.bdrcID, changelogStr);\n\n    try {\n      const response = await axios.put(`https://iiifpres-dev.bdrc.io/bvm/ig:${volume}`, manifest, {\n        headers: {\n          Authorization: 'Bearer ' + app_token\n        }\n      });\n      manifest.rev = response.data.rev;\n    } catch (err) {\n      // TODO: print error:\n      console.error(err);\n    }\n  } else {\n    console.error('users must be logged in');\n  }\n}\n\nexport default saveManifest;","map":{"version":3,"sources":["/Users/aplchian/Documents/code/buda-next/api/postUpdate.ts"],"names":["axios","add_changelog","manifest","userQname","changelogStr","now","Date","changelog","time","toISOString","message","user","changes","push","saveManifest","auth0","isAuthenticated","console","log","app_token","localStorage","getItem","volume","bdrcID","response","put","headers","Authorization","rev","data","err","error"],"mappings":"AAAA,OAAOA,KAAP,MAAkB,OAAlB;;AAIA;AACA,SAASC,aAAT,CAAuBC,QAAvB,EAAgDC,SAAhD,EAAmEC,YAAnE,EAA4F;AACxF,QAAMC,GAAG,GAAG,IAAIC,IAAJ,EAAZ;AACA,QAAMC,SAAS,GAAG;AACdC,IAAAA,IAAI,EAAEH,GAAG,CAACI,WAAJ,EADQ;AAEdC,IAAAA,OAAO,EAAEN,YAFK;AAGdO,IAAAA,IAAI,EAAER;AAHQ,GAAlB;AAKAD,EAAAA,QAAQ,CAACU,OAAT,CAAiBC,IAAjB,CAAsBN,SAAtB;AACH;;AAMD,eAAeO,YAAf,CACIZ,QADJ,EAEIa,KAFJ,EAGIX,YAAY,GAAG;AAAE,YAAU,gBAAZ;AAA8B,eAAa;AAA3C,CAHnB,EAIE;AACE;AACA,MAAIW,KAAK,IAAIA,KAAK,CAACC,eAAnB,EAAoC;AAChCC,IAAAA,OAAO,CAACC,GAAR,CAAY,MAAZ,EAAoBH,KAAK,CAACJ,IAA1B,EADgC,CAGhC;AACA;AACA;AACA;;AAEA,UAAMQ,SAAS,GAAGC,YAAY,CAACC,OAAb,CAAqB,UAArB,CAAlB,CARgC,CAUhC;AAEA;;AACA,UAAMC,MAAM,GAAGpB,QAAQ,CAAC,UAAD,CAAvB;AACAD,IAAAA,aAAa,CAACC,QAAD,EAAWa,KAAK,CAACJ,IAAN,CAAWY,MAAtB,EAA8BnB,YAA9B,CAAb;;AACA,QAAI;AACA,YAAMoB,QAAkC,GAAG,MAAMxB,KAAK,CAACyB,GAAN,CAC5C,uCAAsCH,MAAO,EADD,EAE7CpB,QAF6C,EAG7C;AACIwB,QAAAA,OAAO,EAAE;AACLC,UAAAA,aAAa,EAAE,YAAYR;AADtB;AADb,OAH6C,CAAjD;AASAjB,MAAAA,QAAQ,CAAC0B,GAAT,GAAeJ,QAAQ,CAACK,IAAT,CAAcD,GAA7B;AACH,KAXD,CAWE,OAAOE,GAAP,EAAY;AACV;AACAb,MAAAA,OAAO,CAACc,KAAR,CAAcD,GAAd;AACH;AACJ,GA9BD,MA8BO;AACHb,IAAAA,OAAO,CAACc,KAAR,CAAc,yBAAd;AACH;AACJ;;AAED,eAAejB,YAAf","sourcesContent":["import axios from 'axios'\nimport { AxiosResponse } from \"axios\";\nimport { Buda } from '../../buda/types'\n\n// having a changelog is mandatory\nfunction add_changelog(manifest: Buda.Manifest, userQname: string, changelogStr: Buda.Text) {\n    const now = new Date()\n    const changelog = {\n        time: now.toISOString(),\n        message: changelogStr,\n        user: userQname,\n    }\n    manifest.changes.push(changelog)\n}\n\ninterface PutAnswer {\n    rev: string\n}\n\nasync function saveManifest(\n    manifest: Buda.Manifest,\n    auth0: any,\n    changelogStr = { '@value': 'no log message', '@language': 'en' }\n) {\n    // first check: users must be logged in\n    if (auth0 && auth0.isAuthenticated) {\n        console.log('user', auth0.user)\n\n        // DEPRECATED ? not sure we really need this...\n        // get an app token from IIIFPres Auth0 app\n        // const json = await axios.post(\"https://bdrc-io.auth0.com/oauth/token\", config.iiifpres, { headers: { 'content-type': 'application/json' } })\n        // const app_token = json.data.access_token\n\n        const app_token = localStorage.getItem('id_token')\n\n        // and a changelog string must be provided (when the save button is pressed)\n\n        // post updated manifest to api!\n        const volume = manifest['imggroup']\n        add_changelog(manifest, auth0.user.bdrcID, changelogStr)\n        try {\n            const response: AxiosResponse<PutAnswer> = await axios.put(\n                `https://iiifpres-dev.bdrc.io/bvm/ig:${volume}`,\n                manifest,\n                {\n                    headers: {\n                        Authorization: 'Bearer ' + app_token,\n                    },\n                }\n            )\n            manifest.rev = response.data.rev\n        } catch (err) {\n            // TODO: print error:\n            console.error(err)\n        }\n    } else {\n        console.error('users must be logged in')\n    }\n}\n\nexport default saveManifest\n"]},"metadata":{},"sourceType":"module"}